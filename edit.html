<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ¬åœ°å¯¼èˆªç¼–è¾‘å™¨</title>
    <style>
        *{box-sizing:border-box;font-family:system-ui,sans-serif}
        body{margin:0;padding:20px;background:#f6f7f9}
        .container{max-width:900px;margin:0 auto;background:#fff;padding:24px;border-radius:12px}
        input, select{width:100%;padding:10px;margin:6px 0;border:1px solid #ddd;border-radius:6px}
        button{padding:10px 16px;background:#3b82f6;color:#fff;border:none;border-radius:8px;cursor:pointer;margin:5px 0}
        .btn-danger{background:#ef4444}
        .btn-success{background:#10b981}
        .btn-warning{background:#f59e0b}
        .btn-info{background:#06b6d4}
        .item{display:flex;gap:8px;margin:8px 0;align-items:center}
        .item input, .item select{flex:1}
        .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content-center}
        .modal .box{background:#fff;padding:24px;border-radius:12px;width:90%;max-width:400px}
        .stats{background:#f8fafc;padding:10px;border-radius:6px;margin:10px 0;font-size:14px}
        
        /* åˆ†åŒºæ ·å¼ */
        .category-tag {
            display: inline-flex;
            align-items: center;
            background: #e2e8f0;
            padding: 6px 12px;
            margin: 5px;
            border-radius: 4px;
            font-size: 14px;
        }
        .category-remove {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            margin-left: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            line-height: 1;
        }
        .category-edit {
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            margin-left: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            line-height: 1;
        }
        
        /* ç¼–è¾‘æ¨¡å¼æ ·å¼ */
        .category-edit-input {
            width: 120px;
            padding: 4px 8px;
            border: 1px solid #3b82f6;
            border-radius: 3px;
            font-size: 14px;
        }

        /* æ–‡ä»¶ä¸Šä¼ æ ·å¼ */
        .file-input {
            display: none;
        }
        .file-label {
            display: inline-block;
            padding: 8px 16px;
            background: #06b6d4;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px 0;
        }
        .file-label:hover {
            background: #0891b2;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>æœ¬åœ°å¯¼èˆªç¼–è¾‘å™¨</h2>

    <!-- å¯¼å…¥/å¯¼å‡ºæ§åˆ¶ -->
    <div style="margin:15px 0;padding:15px;background:#f0f9ff;border-radius:8px;">
        <h4>æ•°æ®ç®¡ç†</h4>
        <label class="file-label">
            ğŸ“ å¯¼å…¥ config.json
            <input type="file" id="import-file" class="file-input" accept=".json" onchange="importConfig(this.files[0])">
        </label>
        <button onclick="exportConfig()" class="btn-info">ğŸ“¤ å¯¼å‡ºå½“å‰é…ç½®</button>
        <button onclick="resetToDefault()" class="btn-danger">ğŸ”„ é‡ç½®ä¸ºé»˜è®¤</button>
    </div>

    <input id="avatar" placeholder="å¤´åƒURL" value="">
    <input id="nickname" placeholder="ç«™ç‚¹åç§°" value="">
    <input id="motto" placeholder="ä¸ªæ€§ç­¾å" value="">

    <h3>å¯¼èˆªé¡¹ç®¡ç†</h3>
    
    <!-- åˆ†åŒºç®¡ç† -->
    <div style="margin:15px 0;padding:15px;background:#f8fafc;border-radius:8px;">
        <h4>åˆ†åŒºè®¾ç½®</h4>
        <div id="categories-control">
            <input id="new-category" placeholder="æ–°åˆ†åŒºåç§°" style="width:200px;display:inline-block">
            <button onclick="addCategory()" class="btn-success">æ·»åŠ åˆ†åŒº</button>
            <div id="categories-list" style="margin-top:10px;"></div>
        </div>
    </div>

    <!-- å¯¼èˆªé¡¹åˆ—è¡¨ -->
    <div id="items"></div>

    <button onclick="addItem()">æ·»åŠ å¯¼èˆªé¡¹</button>
    <button onclick="checkPasswordAndSave()">ä¿å­˜å¹¶ä¸‹è½½ config.json</button>
    
    <div class="stats" id="stats">ç»Ÿè®¡ï¼š1ä¸ªåˆ†åŒºï¼Œ0ä¸ªå·¥å…·</div>
</div>

<!-- å¯†ç å¼¹çª— -->
<div class="modal" id="pwdModal">
    <div class="box">
        <h3>è¯·è¾“å…¥å¯†ç </h3>
        <input id="pwdInput" type="password" placeholder="å¯†ç ">
        <button onclick="checkPassword()">ç¡®è®¤</button>
        <button onclick="closePwd()">å–æ¶ˆ</button>
    </div>
</div>

<script>
    // ====================== æœ¬åœ°å†™æ­»å¯†ç  ======================
    const PASSWORD = "123456";

    // åˆå§‹åŒ–æ•°æ® - é»˜è®¤åªæœ‰ä¸€ä¸ª"é»˜è®¤"åˆ†åŒºï¼Œæ²¡æœ‰å¯¼èˆªé¡¹
    let categories = ["é»˜è®¤"];
    let navList = [];
    let editingCategoryIndex = -1; // å½“å‰æ­£åœ¨ç¼–è¾‘çš„åˆ†åŒºç´¢å¼•

    // æ¸²æŸ“åˆ†åŒºåˆ—è¡¨
    function renderCategories() {
        const el = document.getElementById("categories-list");
        el.innerHTML = categories.map((cat, i) => {
            if (i === editingCategoryIndex) {
                // ç¼–è¾‘æ¨¡å¼
                return `
                    <div class="category-tag">
                        <input type="text" class="category-edit-input" value="${cat}" 
                               id="edit-category-${i}" onkeypress="handleCategoryEditKeypress(event, ${i})">
                        <button class="category-edit" onclick="saveCategoryEdit(${i})">âœ“</button>
                        <button class="category-remove" onclick="cancelCategoryEdit()">Ã—</button>
                    </div>
                `;
            } else {
                // æ˜¾ç¤ºæ¨¡å¼
                return `
                    <div class="category-tag">
                        ${cat}
                        <button class="category-edit" onclick="startCategoryEdit(${i})">âœ</button>
                        ${categories.length > 1 ? `<button class="category-remove" onclick="removeCategory(${i})">Ã—</button>` : ''}
                    </div>
                `;
            }
        }).join('');
        
        // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œèšç„¦è¾“å…¥æ¡†
        if (editingCategoryIndex !== -1) {
            setTimeout(() => {
                const input = document.getElementById(`edit-category-${editingCategoryIndex}`);
                if (input) {
                    input.focus();
                    input.select();
                }
            }, 10);
        }
    }

    // å¼€å§‹ç¼–è¾‘åˆ†åŒº
    function startCategoryEdit(index) {
        editingCategoryIndex = index;
        renderCategories();
    }

    // å–æ¶ˆç¼–è¾‘
    function cancelCategoryEdit() {
        editingCategoryIndex = -1;
        renderCategories();
    }

    // ä¿å­˜åˆ†åŒºç¼–è¾‘
    function saveCategoryEdit(index) {
        const input = document.getElementById(`edit-category-${index}`);
        const newName = input.value.trim();
        
        if (newName && newName !== categories[index]) {
            // æ£€æŸ¥æ˜¯å¦é‡å
            if (categories.some((cat, i) => i !== index && cat === newName)) {
                alert("åˆ†åŒºåç§°å·²å­˜åœ¨ï¼");
                return;
            }
            
            const oldName = categories[index];
            categories[index] = newName;
            
            // æ›´æ–°æ‰€æœ‰ä½¿ç”¨è¯¥åˆ†åŒºçš„å·¥å…·
            navList.forEach(item => {
                if (item.category === oldName) {
                    item.category = newName;
                }
            });
        }
        
        editingCategoryIndex = -1;
        renderCategories();
        renderItems();
    }

    // å¤„ç†ç¼–è¾‘æ—¶çš„æŒ‰é”®äº‹ä»¶
    function handleCategoryEditKeypress(event, index) {
        if (event.key === 'Enter') {
            saveCategoryEdit(index);
        } else if (event.key === 'Escape') {
            cancelCategoryEdit();
        }
    }

    // æ¸²æŸ“å¯¼èˆªé¡¹åˆ—è¡¨
    function renderItems() {
        const el = document.getElementById("items");
        el.innerHTML = "";
        navList.forEach((item, i) => {
            const div = document.createElement("div");
            div.className = "item";
            div.innerHTML = `
                <select onchange="update(${i},'category',this.value)" style="flex: 0.8;">
                    ${categories.map(cat => 
                        `<option value="${cat}" ${item.category === cat ? 'selected' : ''}>${cat}</option>`
                    ).join('')}
                </select>
                <input placeholder="å·¥å…·åç§°" value="${item.name}" oninput="update(${i},'name',this.value)" style="flex: 1.2;">
                <input placeholder="å›¾æ ‡URLæˆ–faå›¾æ ‡" value="${item.icon}" oninput="update(${i},'icon',this.value)">
                <input placeholder="é“¾æ¥URL" value="${item.url}" oninput="update(${i},'url',this.value)">
                <input placeholder="æè¿°" value="${item.desc || ''}" oninput="update(${i},'desc',this.value)" style="flex: 1.2;">
                <button class="btn-danger" onclick="del(${i})" style="flex: 0.3;">åˆ é™¤</button>
            `;
            el.appendChild(div);
        });
        updateStats();
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStats() {
        const categoryCount = new Set(navList.map(item => item.category)).size;
        const toolCount = navList.length;
        document.getElementById("stats").innerHTML = 
            `ç»Ÿè®¡ï¼š${categoryCount}ä¸ªåˆ†åŒºï¼Œ${toolCount}ä¸ªå·¥å…·ï¼ˆåˆ†åŒºé™åˆ¶ï¼šæœ€å¤š100ä¸ªï¼‰`;
    }

    function update(i, k, v) { 
        navList[i][k] = v; 
        updateStats();
    }
    
    function addItem() { 
        navList.push({
            name: "", 
            icon: "", 
            url: "", 
            desc: "",
            category: categories[0] || "é»˜è®¤"
        }); 
        renderItems(); 
    }
    
    function del(i) { 
        navList.splice(i, 1); 
        renderItems(); 
    }

    // åˆ†åŒºç®¡ç†
    function addCategory() {
        const newCat = document.getElementById("new-category").value.trim();
        if (newCat) {
            if (categories.includes(newCat)) {
                alert("åˆ†åŒºåç§°å·²å­˜åœ¨ï¼");
                return;
            }
            categories.push(newCat);
            renderCategories();
            renderItems();
            document.getElementById("new-category").value = "";
        }
    }

    function removeCategory(index) {
        if (categories.length > 1) {
            const catToRemove = categories[index];
            // å°†è¯¥åˆ†åŒºçš„å·¥å…·ç§»åˆ°ç¬¬ä¸€ä¸ªåˆ†åŒº
            navList.forEach(item => {
                if (item.category === catToRemove) {
                    item.category = categories[0];
                }
            });
            categories.splice(index, 1);
            renderCategories();
            renderItems();
            
            // å¦‚æœæ­£åœ¨ç¼–è¾‘çš„åˆ†åŒºè¢«åˆ é™¤ï¼Œå–æ¶ˆç¼–è¾‘çŠ¶æ€
            if (editingCategoryIndex === index) {
                editingCategoryIndex = -1;
            }
        } else {
            alert("è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªåˆ†åŒº");
        }
    }

    // ====================== å¯¼å…¥/å¯¼å‡ºåŠŸèƒ½ ======================

    // å¯¼å…¥é…ç½®æ–‡ä»¶
    function importConfig(file) {
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const config = JSON.parse(e.target.result);
                loadConfig(config);
                alert('é…ç½®æ–‡ä»¶å¯¼å…¥æˆåŠŸï¼');
            } catch (error) {
                alert('é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å†…å®¹');
                console.error('å¯¼å…¥é”™è¯¯:', error);
            }
        };
        reader.readAsText(file);
    }

    // åŠ è½½é…ç½®æ•°æ®
    function loadConfig(config) {
        // æ¸…ç©ºå½“å‰æ•°æ®
        categories = ["é»˜è®¤"];
        navList = [];
        
        // åŠ è½½ç«™ç‚¹ä¿¡æ¯
        if (config.site) {
            document.getElementById('avatar').value = config.site.avatar || '';
            document.getElementById('nickname').value = config.site.nickname || '';
            document.getElementById('motto').value = config.site.motto || '';
        }
        
        // åŠ è½½åˆ†åŒºå’Œå·¥å…·
        if (config.categories && Array.isArray(config.categories)) {
            categories = [];
            config.categories.forEach(category => {
                if (category.name && !categories.includes(category.name)) {
                    categories.push(category.name);
                }
                
                if (category.tools && Array.isArray(category.tools)) {
                    category.tools.forEach(tool => {
                        navList.push({
                            name: tool.name || '',
                            icon: tool.icon || '',
                            url: tool.url || '',
                            desc: tool.desc || '',
                            category: category.name || 'é»˜è®¤'
                        });
                    });
                }
            });
            
            // ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªåˆ†åŒº
            if (categories.length === 0) {
                categories = ["é»˜è®¤"];
            }
        } else if (config.navList && Array.isArray(config.navList)) {
            // å…¼å®¹æ—§æ ¼å¼ï¼ˆæ²¡æœ‰åˆ†åŒºçš„é…ç½®ï¼‰
            config.navList.forEach(item => {
                navList.push({
                    name: item.name || '',
                    icon: item.icon || '',
                    url: item.url || '',
                    desc: item.desc || '',
                    category: "é»˜è®¤"
                });
            });
        }
        
        // é‡æ–°æ¸²æŸ“ç•Œé¢
        renderCategories();
        renderItems();
    }

    // å¯¼å‡ºå½“å‰é…ç½®ï¼ˆé¢„è§ˆï¼‰
    function exportConfig() {
        const config = getCurrentConfig();
        const configStr = JSON.stringify(config, null, 2);
        
        // åœ¨æ–°çª—å£ä¸­æ˜¾ç¤ºé…ç½®
        const newWindow = window.open('', '_blank');
        newWindow.document.write(`
            <html>
                <head><title>å½“å‰é…ç½®é¢„è§ˆ</title></head>
                <body>
                    <h2>å½“å‰é…ç½®é¢„è§ˆ</h2>
                    <pre style="background:#f5f5f5;padding:20px;border-radius:5px;overflow:auto">${configStr}</pre>
                    <button onclick="window.close()">å…³é—­</button>
                </body>
            </html>
        `);
    }

    // é‡ç½®ä¸ºé»˜è®¤
    function resetToDefault() {
        if (confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤é…ç½®å—ï¼Ÿæ‰€æœ‰å½“å‰æ•°æ®å°†ä¸¢å¤±ï¼')) {
            categories = ["é»˜è®¤"];
            navList = [];
            document.getElementById('avatar').value = '';
            document.getElementById('nickname').value = '';
            document.getElementById('motto').value = '';
            renderCategories();
            renderItems();
            alert('å·²é‡ç½®ä¸ºé»˜è®¤çŠ¶æ€');
        }
    }

    // è·å–å½“å‰é…ç½®
    function getCurrentConfig() {
        // æŒ‰åˆ†åŒºåˆ†ç»„å·¥å…·
        const groupedData = {};
        navList.forEach(item => {
            if (!groupedData[item.category]) {
                groupedData[item.category] = {
                    name: item.category,
                    icon: "",
                    tools: []
                };
            }
            groupedData[item.category].tools.push({
                name: item.name,
                icon: item.icon,
                url: item.url,
                desc: item.desc
            });
        });

        // è®¾ç½®åˆ†åŒºå›¾æ ‡ï¼ˆä½¿ç”¨ç¬¬ä¸€ä¸ªå·¥å…·çš„å›¾æ ‡ï¼‰
        Object.keys(groupedData).forEach(cat => {
            if (groupedData[cat].tools.length > 0) {
                groupedData[cat].icon = groupedData[cat].tools[0].icon;
            }
        });

        // é™åˆ¶åˆ†åŒºæ•°é‡ï¼ˆæœ€å¤š100ä¸ªï¼‰
        const finalCategories = Object.values(groupedData).slice(0, 100);

        return {
            site: {
                avatar: document.getElementById("avatar").value,
                nickname: document.getElementById("nickname").value,
                motto: document.getElementById("motto").value
            },
            categories: finalCategories
        };
    }

    // ä¿å­˜å¹¶ä¸‹è½½
    function saveAndDownload() {
        const data = getCurrentConfig();
        const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "config.json";
        a.click();
        URL.revokeObjectURL(url);
        alert("ä¸‹è½½å®Œæˆï¼è¯·ä¸Šä¼  config.json åˆ°ç½‘ç«™æ ¹ç›®å½•");
    }

    // å¯†ç åŠŸèƒ½
    function checkPasswordAndSave(){
        document.getElementById("pwdModal").style.display = "flex";
    }
    function closePwd(){
        document.getElementById("pwdModal").style.display = "none";
    }
    function checkPassword(){
        const val = document.getElementById("pwdInput").value;
        if(val === PASSWORD){
            closePwd();
            saveAndDownload();
        }else{
            alert("å¯†ç é”™è¯¯");
        }
    }

    // åˆå§‹åŒ–
    function init() {
        renderCategories();
        renderItems();
    }

    init();
</script>
</body>
</html>
